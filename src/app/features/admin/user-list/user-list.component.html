<div class="user-list-container">
  <h1 class="page-title title-centered">Listado de usuarios</h1>

  <div class="toolbar">
    <a [routerLink]="['/admin/dashboard']" class="btn-home" title="Inicio" aria-label="Inicio">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
    </a>
    <div class="search-wrap">
      <svg class="icon search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <input
        type="text"
        class="search-input"
        placeholder="username"
        [(ngModel)]="searchTerm"
      />
    </div>
    <select class="filter-select" [(ngModel)]="filterRol">
      <option *ngFor="let r of roles" [value]="r.value">{{ r.label }}</option>
    </select>
    <select class="filter-select" [(ngModel)]="filterEstado">
      <option *ngFor="let s of statusOptions" [value]="s.value">{{ s.label }}</option>
    </select>
    <a [routerLink]="['/admin/usuarios/crear']" class="btn-create" title="Crear usuario" aria-label="Crear usuario">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <line x1="12" y1="5" x2="12" y2="19"/>
        <line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
    </a>
  </div>

  <div class="table-wrap">
    <table class="users-table">
      <thead>
        <tr>
          <th>USERNAME</th>
          <th>NOMBRE</th>
          <th>ROL</th>
          <th>ÚLTIMO ACCESO</th>
          <th>ESTADO</th>
          <th>ACCIÓN</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers; trackBy: userTrackBy">
          <td class="text-username">{{ user.username }}</td>
          <td class="text-nombre">{{ user.nombre }}</td>
          <td>{{ rolLabel(user.rol) }}</td>
          <td>{{ user.ultimoAcceso }}</td>
          <td>
            <span class="pill" [class.pill-activo]="user.estado === 'activo'" [class.pill-inactivo]="user.estado === 'inactivo'">
              {{ user.estado === 'activo' ? 'Activo' : 'Inactivo' }}
            </span>
          </td>
          <td class="actions-cell">
            <button type="button" class="btn-action btn-view" (click)="viewUser(user)" title="Ver">
              <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
            <button type="button" class="btn-action btn-edit" (click)="editUser(user)" title="Editar">
              <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
            <button type="button" class="btn-action btn-password" (click)="changePassword(user)" title="Cambiar contraseña">
              <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
            </button>
            <button type="button" class="btn-action btn-toggle" (click)="toggleEstado(user)" [title]="user.estado === 'activo' ? 'Desactivar' : 'Activar'">
              <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                <line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/>
              </svg>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <p *ngIf="filteredUsers.length === 0" class="empty-message">No hay usuarios que coincidan con los filtros.</p>
  </div>
</div>

<!-- Modal Ver usuario -->
<div class="modal-overlay" *ngIf="viewModalUser" (click)="closeViewModal()">
  <div class="modal-dialog modal-view" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Ver usuario</h3>
      <button type="button" class="modal-close" (click)="closeViewModal()" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body" *ngIf="viewModalUser">
      <div class="view-user-grid">
        <div class="view-user-row">
          <span class="view-label">Nombre</span>
          <span class="view-value">{{ viewModalUser.nombre }}</span>
        </div>
        <div class="view-user-row">
          <span class="view-label">Username</span>
          <span class="view-value">{{ viewModalUser.username }}</span>
        </div>
        <div class="view-user-row">
          <span class="view-label">Rol</span>
          <span class="view-value">{{ rolLabel(viewModalUser.rol) }}</span>
        </div>
        <div class="view-user-row">
          <span class="view-label">Último acceso</span>
          <span class="view-value">{{ viewModalUser.ultimoAcceso }}</span>
        </div>
        <div class="view-user-row">
          <span class="view-label">Estado</span>
          <span class="view-value">
            <span class="pill" [class.pill-activo]="viewModalUser.estado === 'activo'" [class.pill-inactivo]="viewModalUser.estado === 'inactivo'">
              {{ viewModalUser.estado === 'activo' ? 'Activo' : 'Inactivo' }}
            </span>
          </span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeViewModal()">Cerrar</button>
      <button type="button" class="btn btn-primary" (click)="editUser(viewModalUser!); closeViewModal()">Editar</button>
    </div>
  </div>
</div>

<!-- Modal Cambiar contraseña -->
<div class="modal-overlay" *ngIf="passwordModalUser" (click)="closePasswordModal()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Cambiar contraseña — {{ passwordModalUser.nombre }}</h3>
      <button type="button" class="modal-close" (click)="closePasswordModal()" aria-label="Cerrar">×</button>
    </div>
    <div class="modal-body">
      <p class="modal-user-info">{{ passwordModalUser.username }}</p>
      <div class="password-display">
        <label class="password-label">Nueva contraseña:</label>
        <div class="password-row">
          <span class="password-value">{{ generatedPassword ? (showPasswordInModal ? generatedPassword : '••••••••••••') : '—' }}</span>
          <div class="password-buttons">
            <button type="button" class="btn-small" (click)="showPasswordInModal = !showPasswordInModal" [disabled]="!generatedPassword">
              {{ showPasswordInModal ? 'Ocultar' : 'Mostrar' }}
            </button>
            <button type="button" class="btn-small" (click)="copyPasswordModal()" [disabled]="!generatedPassword">Copiar</button>
            <button type="button" class="btn-small btn-generate-one" (click)="generatePasswordForModal()">Generar</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer" [class.single-button]="!generatedPassword">
      <button type="button" class="btn btn-close" (click)="closePasswordModal()">Cerrar</button>
      <button type="button" class="btn btn-save-password" (click)="confirmPasswordChange()" [disabled]="!generatedPassword" *ngIf="generatedPassword">
        Guardar nueva contraseña
      </button>
    </div>
  </div>
</div>
